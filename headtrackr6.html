<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
	<title>Untitled</title>

    <script src="js/videoTracker/utils.js"></script> 
    <script type="text/javascript" src="js/videoTracker/clmtrackr.js"></script>              
    <script type="text/javascript" src="models/model_spca_20_svm.js"></script>
    <link rel="stylesheet" type="text/css" href='styles/mainStyle.css'>

    <script>
        // getUserMedia only works over https in Chrome 47+, so we redirect to https. Also notify user if running from file.
        if (window.location.protocol == "file:") {
            alert("You seem to be running this example directly from a file. Note that these examples only work when served from a server or localhost due to canvas cross-domain restrictions.");
        } else if (window.location.hostname !== "localhost" && window.location.protocol !== "https:"){
            window.location.protocol = "https";
        }
    </script>

    <!--Adobe Edge Runtime-->
    <script type="text/javascript" charset="utf-8" src="edge_includes/edge.6.0.0.min.js"></script>
    <style>
        .edgeLoad-EDGE-675796740 { visibility:hidden; }
    </style>
    <script>
        AdobeEdge.loadComposition('index', 'EDGE-675796740', {
            scaleToFit: "height",
            centerStage: "horizontal",
            minW: "0px",
            maxW: "undefined",
            width: "550px",
            height: "400px"
        }, {dom: [ ]}, {dom: [ ]});
    </script>
    <!--Adobe Edge Runtime End-->    

</head>
<body style="margin:0;padding:0;">
	<div id="Stage" class="EDGE-675796740">
        <div id="content">      
            <div id="container">
                <video id="videoel" width="320" height="240" preload="auto" loop="" position="absolute; left: 30px; top: 50px;" ></video>
                <canvas id="overlay" width="320" height="240" position="relative; left: 30px; top: 50px;" ></canvas>
                <p id="mensaje1"></p>
                <p id="mensaje2"></p>

                <script>
                    var vid = document.getElementById('videoel');
                    var overlay = document.getElementById('overlay');
                    var overlayCC = overlay.getContext('2d');

                    var btn1 = document.getElementById('startCalibration');
                    var btn2 = document.getElementById('maskbutton');
                    var btn3 = document.getElementById('vidButton');

                    var ctrack = new clm.tracker({useWebGL : true});
                    ctrack.init(pModel);

                    var mask = true;
                    var visible = true; 

                    var calibrado = false;                                      

                    //Variables calibrado
                    var longitudDerecha = 0;
                    var longitudIzquierda = 0;                  
                    var longitudCara;
                    var nariz;
                    var barbilla;

                    //Timer objects
                    var rightItem = 0;
                    var bottomItem = 0;

                    var mens1 = document.getElementById('mensaje1');                
                    var mens2 = document.getElementById('mensaje2');     
                    

                    function startMask() {
                        var btn2 = document.getElementById('maskbutton');
                        if (!mask) {
                            mask = true;
                            btn2.value = "Ocultar mascara";
                        } else {
                            mask = false;
                            btn2.value = "Mostrar mascara";
                        }
                    }

                    function viewVideo() {
                        var btn3 = document.getElementById('vidButton');
                        if (!visible) {
                            visible = true;
                            btn3.value = "Ocultar video";
                        } else {
                            visible = false;
                            btn3.value = "Mostrar video";
                        }
                    }

                    function getDistance(point1,point2) {
                        var x = Math.pow(point1[0] - point2[0], 2);
                        var y = Math.pow(point1[1] - point2[1], 2);

                        return Math.sqrt(x+y);
                    }

                    function getAngle(point1,point2) {
                        longitud = getDistance(point1,point2);

                        var x = Math.pow(point2[0]-point1[0], 2);
                        var y = Math.pow(point2[1]-point1[1], 2);
                    
                        return Math.atan(x/y);
                    }   

                    function startCalibration() {       
                        var btn1 = document.getElementById('startCalibration');            
                        
                        if (mask) {                            
                            var positions = ctrack.getCurrentPosition();    

                            nariz = positions[33];
                            var nariz1 = positions[62];                                         
                            var costados1 = positions[1];
                            var costados2 = positions[13];
                            barbilla = positions[7];

                            longitudCara = getDistance(nariz,barbilla);
                            longitudIzquierda = getDistance(costados1,nariz1);
                            longitudDerecha = getDistance(costados2,nariz1);
                            

                            btn1.value = "Volver a calibrar";
                            btn1.onclick = function(){                              
                                restartCalibration();
                            }

                            ctrack.calibrateFlg(true); 
                            calibrado = true;                                                       
                        } 
                    }

                    function restartCalibration() {
                        var btn1 = document.getElementById('startCalibration');

                        calibrado = false;
                        ctrack.calibrateFlg(false);                     
                        btn1.value = "Calibrar mascara";
                        btn1.onclick = function(){                          
                            startCalibration();
                        }                       
                    }   

                    function getTurnHead(point1,point2,pointReference) {

                        var longDerecha = getDistance(point1,pointReference);
                        var longIzquierda = getDistance(point2,pointReference);
                        var ret;
                        if (longDerecha < longitudDerecha * 0.8) {
                            ret = 'Derecha';
                        } else if (longIzquierda < longitudIzquierda * 0.8) {
                            ret = 'Izquierda';
                        } else {
                            ret = 'Centro';
                        }
                        return ret;
                    }

                    function startVideo() {
                        vid.play();     
                        ctrack.start(vid);               
                        drawLoop();
                    }

                    function drawLoop() {                   
                        requestAnimFrame(drawLoop);

                        overlayCC.clearRect(0, 0, 320, 240);                                                

                        var positions = ctrack.getCurrentPosition();                                                
                        if (mask)   ctrack.draw(overlay);

                        if (visible) { 
                            vid.style.visibility = "visible";
                        } else {
                            vid.style.visibility = "hidden";
                        }

                        if (calibrado) {              
                            var barbilla1 = positions[7];

                            var nariz1 = positions[33];
                            var nariz2 = positions[62];     

                            var costado1 = positions[1];
                            var costado2 = positions[13];

                            var angulo = getAngle(nariz1,nariz2);                           
                            var lado = getTurnHead(costado1,costado2,nariz2);      
                            var longCara = getDistance(nariz1,barbilla1);                                                

                            if (angulo < 0.1 && lado == 'Centro') {                                  
                                if (longCara < longitudCara*0.9) {
                                    var l1 = getDistance(nariz1,nariz);
                                    var l2 = getDistance(barbilla1,barbilla);
                                    if (l1 < l2) { //arriba
                                        AdobeEdge.getComposition("EDGE-675796740").getStage().getSymbol('topball').play();
                                        AdobeEdge.getComposition("EDGE-675796740").getStage().getSymbol('topball').$("bells007")[0].play();                                         
                                    } else {
                                        if (bottomItem == 0) {
                                            AdobeEdge.getComposition("EDGE-675796740").getStage().getSymbol('bottomball').play();     
                                            AdobeEdge.getComposition("EDGE-675796740").getStage().getSymbol('bottomball').$("fuzz2")[0].play();
                                            bottomItem++;
                                        } else {
                                            bottomItem++;
                                            if (bottomItem == 100) {
                                                bottomItem = 0;
                                            }
                                        }                                     
                                    }                                    
                                } else {                                                                        
                                    AdobeEdge.getComposition("EDGE-675796740").getStage().getSymbol('redball').getSymbol("vibro").stop();
                                    AdobeEdge.getComposition("EDGE-675796740").getStage().getSymbol('redball').getSymbol("vibro").$("vibro2")[0].pause();
                                }
                            } else {
                                AdobeEdge.getComposition("EDGE-675796740").getStage().getSymbol('bottomball').stop();     
                                AdobeEdge.getComposition("EDGE-675796740").getStage().getSymbol('bottomball').$("fuzz2")[0].pause();                                  
                               
                                if (lado == 'Izquierda') {   //Izquierda
                                    AdobeEdge.getComposition("EDGE-675796740").getStage().getSymbol('redball').getSymbol("vibro").play();
                                    AdobeEdge.getComposition("EDGE-675796740").getStage().getSymbol('redball').getSymbol("vibro").$("vibro2")[0].play(0.1);                                    
                                } else {
                                    if (lado == 'Derecha') { //Derecha
                                        if (rightItem == 0) {
                                            AdobeEdge.getComposition("EDGE-675796740").getStage().getSymbol("rightball").getSymbol("knocker").play();
                                            rightItem++;
                                        } else {
                                            rightItem++;
                                            if (rightItem == 80) {                                                
                                                rightItem = 0;
                                            }
                                        }                    
                                    } else {
                                        rightItem = 0;
                                    }

                                }   
                            } 
                        }               
                    }                         

                    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
                    window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

                    if (navigator.getUserMedia) {
                        
                        var videoSelector = {video : true};
                        if (window.navigator.appVersion.match(/Chrome\/(.*?) /)) {
                            var chromeVersion = parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1], 10);
                            if (chromeVersion < 20) {
                                videoSelector = "video";
                            }
                        };
                    
                        navigator.getUserMedia(videoSelector, function( stream ) {
                            if (vid.mozCaptureStream) {
                                vid.mozSrcObject = stream;
                            } else {
                                vid.src = (window.URL && window.URL.createObjectURL(stream)) || stream;
                            }
                            vid.play();
                        }, function() {
                            alert("There was some problem trying to fetch video from your webcam. If you have a webcam, please make sure to accept when the browser asks for access to your webcam.");
                        });
                    } else {                    
                        alert("This demo depends on getUserMedia, which your browser does not seem to support. :(");
                    }

                    startVideo();
                </script>
            </div>
        </div>
        <div id="controles">
            <input class="btn" type="button" value="Calibrar puntos" onclick="startCalibration()" id="startCalibration">
            <input class="btn" type="button" value="Ocultar mascara" onclick="startMask()" id="maskbutton">
            <input class="btn" type="button" value="Ocultar video" onclick="viewVideo()" id="vidButton">
        </div>
	</div>

    
</body>
</html>